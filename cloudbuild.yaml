steps:
# Run unit tests
- name: 'gcr.io/cloud-builders/go'
  args: ['install', '.']
  env: ['PROJECT_ROOT=github.com/JTurpin/slack-bughouse']
- name: 'gcr.io/cloud-builders/go:debian'
  args: ['test', '-v', '-race', './...']
  env: ['PROJECT_ROOT=github.com/JTurpin/slack-bughouse']

# Run component tests
- name: 'docker/compose:1.15.0'
  args: ['up', '--abort-on-container-exit', '--exit-code-from', 'bughouse-test']
  waitFor: ['-']
  env:
  - 'PROJECT_ID=$PROJECT_ID'

# Build container
- name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/slack-bughouse-image', '.' ]

images:
- 'gcr.io/$PROJECT_ID/slack-bughouse-image'
